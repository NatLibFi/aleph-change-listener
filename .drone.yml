---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:
  - name: Audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: Install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true
    commands:
      - npm ci

  - name: Test
    image: node:12
    commands:
      - npm test

  # Disabled because the original code didn't have coverage checking at all and tests aren't very comprehensive
  #- name: check-coverage
  #  image: node:12
  #  commands:
  #    - npm run coverage

  - name: Build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: Static-security-scan
    image: quay.io/natlibfi/njsscan
    commands:
      - njsscan dist

  - name: Npm
    image: plugins/npm
    settings:
      registry: 'https://registry.npmjs.org/'
      token:
      from_secret: npm_token
    when:
      event: tag
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - master

steps:
  - name: Publish
    image: quay.io/natlibfi/drone-npm-git-publish
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_gpg_key:
        from_secret: gpg_key
---
kind: secret
name: npm_token
data: l6vyZaMJQp4J/af0PFPIOp//7UvQ7QBEP8JeBA==
---
kind: secret
name: ssh_key
data: 96O7i+z7T5JtZ4n+OSnRU5wCfzs44dwLMxgNAdI55+USPQzq3Nm5p/FpxymXgwrXTdCkxehvlHLGBkcXlkKtbOMV8gzm81KG/C9RfavJQBbtZo1JmSTcVvvtNtv4MYPCJfwiMTCBvAdBeOtS5Xr6gOwcSoY7h7aI1vM2PQn4/NGNilthPO+Z+kKgNxNogcs8aptYxoUGioLpZfLg3c/iiMU4Ox7J3MZ0xcWjfEunx/lXeLkjUfr/nK2uAFoYGsONYabrr5Xflhcgt7X3DgdjvL79wxzlngfunjkLVRP675GuAeXb7+G8/FhrvRYJVBgxAuMklLFe4UY25s+c+ohLzwaxEqs35KacYbmSh1sif9H8HHZFllWAruX+V98aNGad0IcG3tCFVyU4ENaBMbe3zkfxEUzp2k4LUqpmwFvgtUz9wZb9E5AyjpJsKZGojkmQqoyakWWfV9Ynq8C16NQ6XGyaTfeKTeh0oyzf7e60ulh14wOSsEoJ+eAaqgzm/q/xVLm2PjtzGshLK8a4vYOHoCaBMBPW0nYUe089SZiNOdq9lS06DY4lTaM3AxujZ/nZ3F/oZ5aYeUYB1g59GOx/6FqR8jzV5RU+kKdWgPIPBWmTaabUN5nH0Mi6XYvkJIvOvu7RI2xZtBccBEeVC+hUXwc9YaMOZaNANh7eCo5BYc/a4akGA2lfchUZFqELK5Z3vGOh8KKbPrf/CSGNldZSqKfM5O4xHZvuTdlegPsKi98zFNPmNua99/hZyCzl5QT8TYpmy6SQUofkPenCa2lfawpooYEiee3xu/hQ7PypcAYk1THNVbSfIT2dLxvZpB39mufhozB6eE53dRhx1L56ZHDBAXOLxyUGAqahFQMomV980S3ocsEhILIl970/wGBtTOPGGRJCA0/W9Qr1/L87xy/xiMZz374bxk2n+r0em1gW9+2sX4HBA8wxN1iRmwtjIV7H4mU0SXy8DNTMuFJBofGOoctrDS71eBevAbD3fxL/Gm2QKjI4Aguic7fPZZJwdAckYjUbUIG6InTnT3LKmIBTUCvXYX/1Jg4kAW2bUP2wexTJljAPNsQZsjvQZBxUL10Nf/rQNDIrn+7L4XZH+O37Dv6DWoL9ylTgQIuKAHJUMXnN8LF5jU03viBAr9Lh5rcwLfynUhhKmXiLzVBfIiXwHDupRQeKfRA6x74Dv6Qn80xdwpnSBdFrgHdjTC0itb5Qx8svZgXDIh7/s4COTPSBTMHHtR9Z4GmCsV/gCLHfw2FJr+AzO2r9l1t0/T9Fn5Y/yGF49yiod34DTJNtnna1SSeBgSCmMhACsbjNEvmrurcAhnB1lGieoKv8jEC3H9Y1gejLmHiSm11L1Z5C+BkeoI1LYfKsS6hdtv/NyRvNmLxo6C+LBJepou48WdxK2maJQr7kohxXDH2HlJ1mwCNVodof9dBTJ9BkdT6qHu1ONblef8IEk0SQiI8Fn0lLtjLLLK93QYl1Fm3Ly4sHm0RuX/yHwWY34b3p+Grw0HuPQc5T8p5LcniD2dygEXs43hALhvmje6aj7kbc5fyB1DQ/EaPF/dL89AAvg1x3D6z0XJdXcMfiYbvz87A09JILhuB7a4FNcqIq5slYcn3Sl2c3JH5dKH1+Bql2zfhOIa5BqJ7dx5Z2V47Xu8VMUOSOExAt3LdLtT5kE4HtsWshO854cR3GiegehBg1IV4B/SuMTDTe/9AKZfk0FnjpAGrQAMwSiAZjxR7xrjfoBpt91eES4FrYnNbHDB/jCPZjfJ99LsGMubVea65lNLB7ynNoxB7jEbitUkY2qS3F0IGG1mnqdyd8BzhaZjPJL45v/3oD77L2M9J6Q9dQlqpsEgA7/NcY7oi668rdCeBA8jsD6ANLZso5ocrI7yuId7V7ddgLzjTIHm3T5yzPLMWASOVlmmBY9TweotpuknuK+XIpTiQQ4VUxxzt/Ks007iouEuS+7GR2QaidUBVz44WBR1rrbAhhtwI4ktDPuqB16eqjxbymynmsq4Q9oeIuyK71FWstvCoNcYSQ9Y0cvHn9J9y6dw+sKiD4fvvclZ0HUwVZzyMjNa4KNZm1xFY34HLWUeyNU7PK9hkSHlXAvVYND/rmOLrKnC1vu11S8EvV98zSyxQ61apBmkA8t5kGKkGNzpcngd7qey1ZuTuDDwsO3FBzY9AtLZqyph1dkhlxp+q4LDyIBwpOr1P230RDD7edMLKpP2bvnrSG89I25lwxFV+jc1D044GLSrjl7CXnV5iVr+QxQ7dMpyFEzoU11sGQ1xpO07nwJ16Wj7mH+XkRhqQ3+uWjpYi0jcDeRNzNzsMUNC1W6zGDt7wdl29XVqxhkOV4NAcEguPrsVeBpxlyKPWaQbnpL7CnPWu19QjNfxQLF9PZ5pn0v0tHWMTiV+35p/nrEWAG5aX1YqLEaGV9sfc0kJVP/N+w6wcyIs5nijVG7vhLH2GOPk2CU2FqxDSBjXNZsK1RDk5UYD8Sskzj4h8hZ9GCYFhq3P2oslTYJrm2bCkaVp3lFnI/HKCUxVBVg2bjAehPARNLQNj1xAwepR4jgWsq2l4sdBuVd4pzhdTMJ/UbA8of100hxJH1nYJ4cmqfZJ+AVtAeKFxP2C9Vyj17DhHia5cno8oP+BdtcvHHg55v0dW9LaJ+eX6U2xCv8mmu1UITXzvXZDjp78sUXgPQsjiUW1Mke+vv48ueSPfyGoopwqvnwuaJyoQ+9yZ6fA1UD4loWd3pzFmDQ660WXCF+oBlw40Q5wrT+6WzFfbUUdsNgbX5F8Y1ByBq3rPvHszEXOR7oG+XHGsotFnIKMKqL0ySWvd63CIQbVU0NYvu08J8dQeTiLC1AaCyJqrQQ49NU6hBRo1q57FlPZikxRrdxHEKweH9lDm7R9Z4dZP3ZLzo00FzMmet84ukhewLode9IXCL+uP8TXNGT25dt0gw6Jn1fFzaVQfBJ63uj/gyHphYNEAEF3NHL9pjTwJa2pSyQZSMQRhdWIUZgAMDq7eEChdkh+gpjBTuEcy9
---
kind: secret
name: gpg_key
data: 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
---
kind: signature
hmac: 522a54495d76e2667e5658c84a2ed1c54b6cb80c6595cdb103dd00f3bbfa39a4

...
